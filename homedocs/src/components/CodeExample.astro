---
import { Code } from "astro:components";
import * as prettier from "prettier";

interface Props {
  title?: string;
  description?: string;
  code: string;
  lang?: string;
}

const { title, description, code, lang = "jsx" } = Astro.props;

// Parse sections from code using // @section and // @section-end markers
function parseSections(codeStr: string): {
  model?: string;
  controller?: string;
  components?: string;
  index?: string;
} {
  const sections: { model?: string; controller?: string; components?: string; index?: string } = {};

  const sectionRegex =
    /\/\/\s*@(model|controller|components|index)[^\n]*\n([\s\S]*?)\/\/\s*@\1-end/g;
  let match;

  while ((match = sectionRegex.exec(codeStr)) !== null) {
    const sectionName = match[1] as "model" | "controller" | "components" | "index";
    sections[sectionName] = match[2].trim();
  }

  return sections;
}

// Normalize indentation
function normalizeIndent(codeStr: string): string {
  if (!codeStr.trim()) return codeStr;

  const lines = codeStr.split("\n");
  const nonEmptyLines = lines.filter((l) => l.trim() !== "");
  if (nonEmptyLines.length === 0) return codeStr;

  const minIndent = nonEmptyLines.reduce((min, line) => {
    const indent = line.match(/^(\s*)/)?.[1].length || 0;
    return Math.min(min, indent);
  }, Infinity);

  if (minIndent > 0 && minIndent !== Infinity) {
    return lines
      .map((line) => line.slice(minIndent))
      .join("\n")
      .trim();
  }

  return codeStr.trim();
}

// Trim export default wrapper from index code
function trimExportDefault(codeStr: string): string {
  const trimmed = codeStr.trim();

  // Handle single-line export default (with or without semicolon)
  if (trimmed.startsWith("export default () => (") && (trimmed.endsWith(");") || trimmed.endsWith(")"))) {
    const endChars = trimmed.endsWith(");") ? 2 : 1;
    return trimmed.slice("export default () => (".length, -endChars).trim();
  }

  // Handle multi-line export default (after Prettier formatting)
  if (trimmed.startsWith("export default () => (")) {
    const lines = trimmed.split("\n");
    // Remove first line (export default () => ()
    lines.shift();
    // Remove last line if it's just ) or );
    const lastLine = lines[lines.length - 1].trim();
    if (lastLine === ");" || lastLine === ")") {
      lines.pop();
    }
    return lines.join("\n").trim();
  }

  return trimmed;
}

// Extract import statements from the top of the file
function extractImports(codeStr: string): string | null {
  const lines = codeStr.split("\n");
  const importLines: string[] = [];
  for (const line of lines) {
    const trimmed = line.trim();
    if (
      trimmed.startsWith("import ") ||
      (importLines.length > 0 &&
        !trimmed.startsWith("//") &&
        !trimmed.startsWith("interface") &&
        !trimmed.startsWith("const") &&
        !trimmed.startsWith("class") &&
        !trimmed.startsWith("export") &&
        trimmed !== "")
    ) {
      importLines.push(line);
    } else if (importLines.length > 0 && trimmed !== "") {
      break;
    }
  }
  return importLines.length > 0 ? importLines.join("\n").trim() : null;
}

// Parse sections from code
const sections = parseSections(code);

// Get index code - either from @index section or use whole code (cleaned up)
const indexCode =
  sections.index ||
  code.replace(/\/\*\*\s*@jsxImportSource\s+\w+\s*\*\/\n?/, "").trim();

// First trim export default wrapper, then format with Prettier
let displayCode = trimExportDefault(indexCode);
try {
  const formatted = await prettier.format(displayCode, {
    parser: "babel-ts",
    printWidth: 80,
    tabWidth: 2,
    semi: false,
    singleQuote: false,
  });

  // Remove leading semicolon that Prettier adds to protect against ASI
  displayCode = formatted.trim().replace(/^;/, "");
} catch (e) {
  // If formatting fails, use original trimmed code
  console.warn("Prettier formatting failed:", e);
}

// Get controller, model, and components code
const controllerCode = sections.controller
  ? normalizeIndent(sections.controller)
  : null;
const modelCode = sections.model ? normalizeIndent(sections.model) : null;
const componentsCode = sections.components ? normalizeIndent(sections.components) : null;

const hasTabs = controllerCode || modelCode || componentsCode;

// Extract imports (only shown if there are other tabs)
const importsCode = hasTabs ? extractImports(code) : null;
---

<div class="code-example my-8 relative" data-pagefind-ignore>
  {title && <h3 class="text-lg font-semibold text-foreground mb-2">{title}</h3>}
  {description && <p class="text-muted-foreground mb-4">{description}</p>}

  <div class="relative">
    <!-- Code Block -->
    <div
      class="code-block rounded-lg overflow-hidden border border-border bg-[hsl(var(--code-bg))]"
    >
      {
        hasTabs && (
          <div class="code-tabs flex border-b border-[hsl(var(--code-border))]">
            <button
              class="code-tab active px-4 py-2 text-xs font-medium uppercase transition-colors"
              data-tab="code"
            >
              Index
            </button>
            {modelCode && (
              <button
                class="code-tab px-4 py-2 text-xs font-medium uppercase transition-colors"
                data-tab="model"
              >
                Model
              </button>
            )}
            {componentsCode && (
              <button
                class="code-tab px-4 py-2 text-xs font-medium uppercase transition-colors"
                data-tab="components"
              >
                Components
              </button>
            )}
            {controllerCode && (
              <button
                class="code-tab px-4 py-2 text-xs font-medium uppercase transition-colors"
                data-tab="controller"
              >
                Controller
              </button>
            )}
            {importsCode && (
              <button
                class="code-tab px-4 py-2 text-xs font-medium uppercase transition-colors"
                data-tab="imports"
              >
                Imports
              </button>
            )}
            <span
              class="ml-auto px-4 py-2 text-xs font-medium uppercase"
              style="color: rgba(255, 255, 255, 0.5);"
            >
              TSX
            </span>
          </div>
        )
      }

      <div class="code-content-wrapper max-h-96 overflow-y-auto">
        <div class="code-content" data-content="code">
          <Code code={displayCode} lang="tsx" theme="github-dark-dimmed" />
        </div>
        {
          controllerCode && (
            <div class="code-content hidden" data-content="controller">
              <Code
                code={controllerCode}
                lang="tsx"
                theme="github-dark-dimmed"
              />
            </div>
          )
        }
        {
          modelCode && (
            <div class="code-content hidden" data-content="model">
              <Code code={modelCode} lang="tsx" theme="github-dark-dimmed" />
            </div>
          )
        }
        {
          componentsCode && (
            <div class="code-content hidden" data-content="components">
              <Code code={componentsCode} lang="tsx" theme="github-dark-dimmed" />
            </div>
          )
        }
        {
          importsCode && (
            <div class="code-content hidden" data-content="imports">
              <Code code={importsCode} lang="tsx" theme="github-dark-dimmed" />
            </div>
          )
        }
      </div>
    </div>

    <!-- Preview - positioned to the right on xl+ screens -->
    <div
      class="preview-container 2xl:absolute 2xl:left-full 2xl:top-0 2xl:bottom-0 2xl:ml-6 2xl:w-[600px] mt-4 2xl:mt-0 2xl:flex 2xl:items-center"
    >
      <!-- Arrow connector - only visible on xl+ -->
      <div
        class="hidden 2xl:flex absolute right-full top-1/2 -translate-y-1/2 items-center"
      >
        <div class="w-4 h-px bg-border"></div>
        <svg
          class="w-3 h-3 text-primary -ml-0.5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
        >
          <path d="m9 18 6-6-6-6" stroke-linecap="round" stroke-linejoin="round"
          ></path>
        </svg>
      </div>

      <div
        class="preview-box not-prose p-4 bg-card border border-border rounded-lg grow overflow-hidden"
      >
        <slot />
      </div>
    </div>
  </div>
</div>

<style>
  /* Reset prose list styles in not-prose areas */
  :global(.not-prose ul) {
    margin: 0 !important;
    padding: 0 !important;
  }

  :global(.not-prose ul > li) {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  :global(.not-prose ol > li) {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  :global(.not-prose .cxe-list-item) {
    padding-left: 20px;
  }

  :global(.not-prose hr) {
    margin: 0.5rem;
  }


  .code-tab {
    position: relative;
    background: transparent;
    border: none;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.5);
  }

  .code-tab:hover {
    color: rgba(255, 255, 255, 0.8);
  }

  .code-tab.active {
    color: #fff;
  }

  .code-tab.active::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--cx-c-brand);
  }

  .code-content :global(pre) {
    margin: 0 !important;
    padding: 1rem !important;
    font-size: 0.8125rem !important;
    line-height: 1.7 !important;
    border-radius: 0 !important;
    background: transparent !important;
    overflow-x: auto;
  }

  .code-content :global(code) {
    font-family: "Fira Code", "Monaco", "Consolas", monospace !important;
  }

  .code-content :global(.line) {
    display: inline-block;
    width: 100%;
  }
</style>

<script is:inline>
  function initCodeExampleTabs() {
    document.querySelectorAll(".code-example").forEach(function (example) {
      var tabs = example.querySelectorAll(".code-tab");
      var contents = example.querySelectorAll(".code-content");

      tabs.forEach(function (tab) {
        tab.addEventListener("click", function () {
          var targetTab = tab.dataset.tab;

          tabs.forEach(function (t) {
            t.classList.remove("active");
          });
          tab.classList.add("active");

          contents.forEach(function (content) {
            var contentTab = content.dataset.content;
            if (contentTab === targetTab) {
              content.classList.remove("hidden");
            } else {
              content.classList.add("hidden");
            }
          });
        });
      });
    });
  }

  initCodeExampleTabs();
  document.addEventListener("astro:page-load", initCodeExampleTabs);
</script>
