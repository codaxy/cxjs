---
import BackToTop from './BackToTop.astro';

interface Props {
  collapsed?: boolean;
}

const { collapsed = false } = Astro.props;
---

<aside class="on-this-page not-prose border border-border rounded-lg p-4 bg-card relative z-10 w-full mt-6 mb-6 xl:absolute xl:-right-58 xl:top-6 xl:mt-0 xl:mb-0 xl:ml-6 xl:w-64 xl:max-h-[calc(100vh-6rem)] xl:overflow-y-auto" {...(collapsed ? { 'data-collapsed': '' } : {})}>
  <div>
    <button
      class="on-this-page-btn flex w-full items-center justify-between text-xs font-semibold uppercase tracking-wider text-muted-foreground hover:text-foreground transition-colors"
      type="button"
      aria-expanded="false"
    >
      On This Page
      <svg
        class="chevron h-4 w-4 transition-transform duration-200"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="m6 9 6 6 6-6"/>
      </svg>
    </button>
    <nav class="on-this-page-content" data-open="false">
      <div class="text-sm on-this-page-links flex flex-col gap-2">
        <!-- Links will be populated by JavaScript -->
      </div>
    </nav>
  </div>
</aside>

<BackToTop />

<style>
  .on-this-page-btn[aria-expanded="false"] .chevron {
    transform: rotate(-90deg);
  }

  .on-this-page-content {
    overflow: hidden;
    transition: opacity 0.15s ease-out, visibility 0.15s ease-out;
  }

  .on-this-page-content[data-open="false"] {
    visibility: hidden;
    opacity: 0;
    height: 0;
  }

  .on-this-page-content[data-open="true"] {
    visibility: visible;
    opacity: 1;
  }

  .on-this-page-content > div {
    margin-top: 0.75rem !important;
  }

  .on-this-page-links :global(a) {
    display: block;
    color: hsl(var(--muted-foreground));
    text-decoration: none !important;
    border-bottom: none !important;
    transition: color 0.15s ease;
    line-height: 1.5;
  }

  .on-this-page-links :global(a:hover) {
    color: hsl(var(--primary)) !important;
    border-bottom: none !important;
  }

  .on-this-page-links :global(.toc-h3) {
    padding-left: 0.75rem;
    font-size: small;
  }

  .on-this-page:has(.on-this-page-content[data-open="true"]) {
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  /* Hover expand only on xl+ screens, but not when user collapsed */
  @media (min-width: 1280px) {
    .on-this-page:not(.user-collapsed):hover {
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    .on-this-page:not(.user-collapsed):hover .on-this-page-content {
      visibility: visible;
      opacity: 1;
      height: auto;
    }

    .on-this-page:not(.user-collapsed):hover .chevron {
      transform: rotate(0deg);
    }
  }
</style>

<script>
  function initOnThisPage() {
    const container = document.querySelector('.on-this-page');
    if (!container) return;

    const linksList = container.querySelector('.on-this-page-links');
    if (!linksList) return;

    // Clear existing links
    linksList.innerHTML = '';

    // Find all h2 and h3 headings in the prose content
    const headings = document.querySelectorAll('.prose h2, .prose h3');

    if (headings.length === 0) {
      // Hide the component if there are no headings
      container.classList.add('hidden');
      return;
    }

    // Show the component
    container.classList.remove('hidden');

    // Build the links
    headings.forEach(heading => {
      if (!heading.id) return;

      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent?.replace(/#$/, '').trim() || '';

      // Add class for h3 indentation
      if (heading.tagName === 'H3') {
        a.classList.add('toc-h3');
      }

      linksList.appendChild(a);
    });

    const btn = container.querySelector('.on-this-page-btn');
    const content = container.querySelector('.on-this-page-content');

    // Expand on desktop if not explicitly collapsed
    if (btn && content && window.innerWidth >= 1280 && !container.hasAttribute('data-collapsed')) {
      btn.setAttribute('aria-expanded', 'true');
      content.setAttribute('data-open', 'true');
    }

    if (btn && content) {
      // Remove existing listeners by cloning
      const newBtn = btn.cloneNode(true) as Element;
      btn.parentNode?.replaceChild(newBtn, btn);

      newBtn.addEventListener('click', () => {
        const expanded = newBtn.getAttribute('aria-expanded') === 'true';
        newBtn.setAttribute('aria-expanded', (!expanded).toString());
        content.setAttribute('data-open', (!expanded).toString());

        // If user collapsed, add class to prevent hover from expanding
        if (expanded) {
          container.classList.add('user-collapsed');
        } else {
          container.classList.remove('user-collapsed');
        }
      });

      // Remove user-collapsed when mouse leaves
      container.addEventListener('mouseleave', () => {
        container.classList.remove('user-collapsed');
      });
    }
  }

  // Initialize on load
  initOnThisPage();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initOnThisPage);
</script>
